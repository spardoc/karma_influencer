<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Análisis - Karma Influencer</title>
    <link rel="stylesheet" href="/static/css/common.css">
    <link rel="stylesheet" href="/static/css/analytics.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>

    <div style="margin-bottom: 20px;">
        <a href="/"><button>⬅ Volver a Inicio</button></a>
    </div>    

    <h1>Análisis</h1>
    <a href="/comments.html?keywords=" id="comments-link">Ver Comentarios</a>
    <div id="analytics-container"></div>

    <script>
        const params = new URLSearchParams(window.location.search);
        const keywords = params.get("keywords")?.split(",") || [];

        document.getElementById("comments-link").href = `/comments.html?keywords=${keywords.join(',')}`;

        async function fetchAnalytics(keyword) {
            const res = await fetch(`/api/analytics/${encodeURIComponent(keyword)}`);
            return res.ok ? await res.json() : null;
        }

        function renderAnalytics(keyword, data) {
            const container = document.getElementById("analytics-container");
            const div = document.createElement("div");
            div.classList.add("analytics-section");
            div.innerHTML = `
                <h3>${keyword}</h3>
                <canvas id="chart-${keyword}" width="300" height="300"></canvas>
                <p><strong>Karma:</strong> ${data.karma_score}</p>
                <p><strong>Promedio:</strong> ${data.average_score.toFixed(2)}</p>
                <p><strong>Recomendación:</strong> ${data.recommendation}</p>
                <hr>
            `;
            container.appendChild(div);

            new Chart(document.getElementById(`chart-${keyword}`), {
                type: 'pie',
                data: {
                    labels: ['Positivo', 'Neutral', 'Negativo'],
                    datasets: [{
                        label: 'Sentimientos',
                        data: [data.positive, data.neutral, data.negative],
                        backgroundColor: ['#4caf50', '#9e9e9e', '#f44336'],
                    }]
                }
            });
        }

        async function loadAnalytics() {
            for (const keyword of keywords) {
                const data = await fetchAnalytics(keyword);
                if (data) renderAnalytics(keyword, data);
            }
        }

        loadAnalytics();
    </script>
</body>
</html>